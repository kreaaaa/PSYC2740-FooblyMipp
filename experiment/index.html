<!DOCTYPE html>
<html>
    <head> 
        <title> Foobly Mipp Experiment  </title>
           <script src="https://unpkg.com/jspsych@7.3.3"></script>
        <link href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css" rel="stylesheet" type="text/css" />
        <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
        <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3"></script>
        <script src="jspsych/modified-image-plugin.js"></script>
        <script src="nonrhymeprime.js"></script>
        <script src="nonrhymesentences.js"></script>
        <script src="association1.js"></script>
        <script src="association2.js"></script>
        <script src="rhymeprime.js"></script>
        <script src="rhymesentences.js"></script>
        <script src="https://unpkg.com/@jspsych/plugin-instructions@2.0.0"></script>
        <script src="https://unpkg.com/@jspsych/plugin-survey-multi-select@2.0.0"></script>
        <script src="https://unpkg.com/@jspsych/plugin-preload@2.0.0"></script>
    </head>
    <body> </body>
    <script> 

 const jsPsych= initJsPsych ();
        var random_attention_trials = jsPsych.randomization.sampleWithoutReplacement([ ... Array (35). keys ()]. map (x => x+ 5), 3);
       // console.log ("random_attention_trials =" + random_attention_trials);

var id = Math.floor(Math.random() * 1000000000);
//console.log("id=", id)

//tag all trials with ID

jsPsych.data.addProperties({
    ID: id
});

var CONDITION = jsPsych.randomization.sampleWithoutReplacement([...Array(2).keys()],1)[0];

var experiment_stimuli = get_stimuli(CONDITION)
//console.log("CONDITION=" + CONDITION);
//console.log("experiment_stimuli=" + experiment_stimuli);

var preload = {
    type:jsPsychPreload,
    auto_preload: true,
    images: ['cash-rock.png', 'rock-cash.png']
}

var initial_instructions = {
    type: jsPsychInstructions,
    pages: [
    'How do we learn new words? <br><br> Most of the words we know we learned spontaneously, like when hearing a novel word while listening to <br> someone speaking, watching TV or while reading. In this study, your task will be to simply read sentences <br> containing new words. After the reading session, we will ask you to use these novel words in a word game. <br> This experiment has three blocks. Each block has reading and testing session.<br> Are you ready to start?',
    'We will present one sentence at a time. <br>Read them carefully. When you are ready, press space bar for the next sentence. <br>In order to make sure you are reading carefully, there will be surprise questions during the reading session. <br><br>You will be asked to type in the novel words from the last sentence you read. <br>Minor spelling mistakes will be tolerated. <br>Type in your answer and press enter when you are ready to move on to the next sentence.',
    'You will now read the sentences. <br> Press SPACEBAR when you have read the sentence and want to move on to the next.'
    ],
show_clickable_nav: true
}
    
var association_instructions= {
            type: jsPsychInstructions,
            pages: [
            'In this segment, you will be asked to type in the first word that comes to your mind when you hear or read a given word. <br> Keep in mind that in this game, you can only use the words you read about in the reading session. <br><br>Type in your answer and press enter when you are ready for the next one.',
            ],
        show_clickable_nav: true
        }

var priming_instructions= {
            type: jsPsychInstructions,
            pages: [
            'This is our final game.<br>You will be presented with slides showing a pile of cash and a bag of trash.<br>Your task will be to respond as quickly as possible, on which side of the screen the cash or the trash is shown.<br>On the same screen, with pictures, two words will be presented. Read the first word,<br>but respond in accordance with the second word. For example, if you see words “boff” and “cash”,<br>respond where the cash is. If you see words “boff” and “trash”, respond where the trash is.',
            'You will press A if you want to choose the picture on the left and <br><br> L if you want to choose the picture on the right'
            ],
        show_clickable_nav: true 
    }

var sentence_number= 0; 
    
var sentence = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: jsPsych.timelineVariable('sentence'),
      choices: [' '],
      on_finish: function(data) {
        last_trial_index = (data.trial_index + 1 ) % 40 ;
        console.log ("last_trial_index = " + last_trial_index);
        sentence_number = (sentence_number + 1 ) % 40;
       console.log ("sentence_number = " + sentence_number);
    },
data: {
        typeoftrial: 'sentence',
        sentence: jsPsych.timelineVariable('sentence'),
        novel1: jsPsych.timelineVariable('novel1'),
        novel2: jsPsych.timelineVariable('novel2'),
    }
}

    var attention = {
    type: jsPsychSurveyText,
    questions: [{prompt: "Type any ONE novel word from the previous sentence:"}],
    data: {
        typeoftrial: 'attention',
    },

    on_finish: function (data){
        var last_trial_data = jsPsych.data.get().filter({typeoftrial: 'sentence'}). last(1).values()[0];
    //console.log("last_trial_data= ", last_trial_data);

    data.novel1= last_trial_data.novel1;
    data.novel2= last_trial_data.novel2;
    data.response = data.response.Q0;

    if(
        jsPsych.pluginAPI.compareKeys(data.response, data.novel1) ||
        jsPsych.pluginAPI.compareKeys(data.response, data.novel2) 
    ){
        data.correct = 1;
       //.log("correct=" + data.correct);
    } else {
        data.correct = 0;
     //   console.log("correct=" + data.correct);}
}
}
}

var attention_conditional= {
        timeline: [attention],
        conditional_function: function(){
            if (random_attention_trials.includes(sentence_number)) {return true;}
            else {return false;}
        }
    }

var training_procedure= {
        timeline:[sentence, attention_conditional],
        timeline_variables: experiment_stimuli[0],
        randomize_order: true,
    };

var association = {
    type: jsPsychSurveyText,
    preamble: 'Type in the first word that comes to mind when you see the word below:',
    questions: [{prompt: jsPsych.timelineVariable('cue')}],
    trial_duration: 10,
    data: {
        typeoftrial: 'association',
        cue: jsPsych.timelineVariable('cue')
    },
    on_finish: function(data){
        data.response = data.response.Q0
    }
}

var association_procedure= {
        timeline: [association],
        timeline_variables: experiment_stimuli[2],
        randomize_order: true,
        repetitions: 3 
    };

var training_plus_association ={
        timeline: [training_procedure, association_instructions, association_procedure],
        repetitions: 3
    };

var slow_experiment_trial = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "<br> Too Slow!</b>! <br> Please try to respond faster.",
        choices: "NO_KEYS",
        trial_duration: 1500
    };

var fixation = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: '+',
    choices: ['NO_KEYS'],
    trial_duration: 500, 
    data: {
    typeoftrial: 'fixation'
        }
    };
    

var image = {
    type: jsPsychImageKeyboardResponse,
    stimulus: jsPsych.timelineVariable('image_path'),
    choices : "NO_KEYS",
    trial_duration: 500,
      stimulus_width: 500,
      maintain_aspect_ratio: true,
      prompt: "<span style= 'font-size:200%'><br><br></span>",
      data: {
        typeoftrial: 'image',
      },
    }


var prime = {
    type: jsPsychImageKeyboardResponse,
    //  trial_duration: 300,
    stimulus: jsPsych.timelineVariable('image_path'),
    choices: "NO_KEYS",
    trial_duration: 300,
    stimulus_width: 500,
    maintain_aspect_ratio: true,
    prompt: function () {
    return "<span style= 'font-size: 200%'><br>" + String (jsPsych.timelineVariable('prime_word')) + "<br></span>";
    },
}

var target = {
    type: jsPsychImageKeyboardResponse,
    stimulus: jsPsych.timelineVariable('image_path'),
    // trial_duration: 300,
    choices: ['A', 'L'],
    stimulus_width: 500,
    maintain_aspect_ratio: true,
    prompt:function () {
        return "<span style= 'font-size: 200%'><br>" + String (jsPsych.timelineVariable('target_word')) + "<br></span>";
    },
    data: {
        typeoftrial: 'target',
        target: jsPsych.timelineVariable('target_word'), 
        prime: jsPsych.timelineVariable('prime_word'),
        type: jsPsych.timelineVariable ('type'),
        relatedness: jsPsych.timelineVariable('relatedness'),
        correct_key: jsPsych.timelineVariable('correct_key'),
        block_number: jsPsych.timelineVariable('block_number')
    },
    on_finish: function(data){
    data.correct= jsPsych.pluginAPI.compareKeys(data.response, data.correct_key);
    }
}

var priming_feedback = {
        timeline: [slow_experiment_trial],
        conditional_function: function(){
        // get the data from the previous trial and check if rt is greater than 800 ms 
        var rt = jsPsych.data.get().last(1).values()[0].rt;
                if (rt > 800) {
                return true;
        } else {
                return false;
            }
    },
        data: {
        typeoftrial: 'fixation'
        }
};

var priming_procedure = {
  timeline:[fixation, image, prime, target, priming_feedback],
        timeline_variables: experiment_stimuli[1],
        randomize_order: true,
        repetitions: 2
};

var practice_procedure = {
    timeline: [fixation, image, prime, target, priming_feedback],
    timeline_variables : practice_stimuli,
    randomize_order: true,
}


var ending_instructions = {
type: jsPsychInstructions,
pages: [
'You will now be asked several demographic questions.<br>Please press on individual text boxes to enter as ENTER will move you on to the next page.'
],
show_clickable_nav: true
}

var demographics_survey1 = {
    type:jsPsychSurveyText,
    preamble: "<h2> Demographics Questionaire <h2>", name:'heading', rows:1, columns: 50,
        questions: [
            {prompt: "What is your age?",
                name: 'age',
                required: true},
            {prompt: "What is your gender?",
                name: 'gender',
                required: true},  
            {prompt: "How many years of formal education have you had? Consider graduating high school to be 12 years.",
                name: 'gender',
                required: true}
            ],
            data: {typeoftrial: 'demographics',
            }    
         }

var demographics_survey2 = {
    type:jsPsychSurveyMultiSelect,
    questions: [
        {
            prompt: "Please select all the racial categories that apply to you:",
            name: 'race',
            options: ['American Indian/Alaskan Native', 'Asian', 'Black/African American', 'Native Hawaiian or other Pacific Islander', 'White/Caucasian', 'More than one race', 'Other'],
            required: true,
            is_multiple: true
        },
    ],
    data: {
        typeoftrial: 'demographics'
    }
}

var demographics_survey3 = {
    type: jsPsychSurveyMultiChoice,
    questions: [
        {
            prompt: " Are you of Hispanic, Latino/a/x or of Spanish origin?",
            name: 'hispanic',
            options: ['Yes', 'No'],
            required: true
        },
        {prompt: "What is your dominant hand?",
            name: 'dominant_hand',
            options: ['Right', 'Left', 'Ambidextrous'],
            required: true
        },
        {prompt: " Please indicate what time of day that you feel most alert:",
        name: 'alert_time',
        options: ['Morning', 'Afternoon', 'Evening', 'No differences'],
        required: true
        },
    ],
    data: {
        typeoftrial: 'demographics',
    },
}

var demographics_survey4 = {
    type: jsPsychHtmlButtonResponse,
    stimulus: "Is English your first language?",
    choices: ['Yes', 'No'],

data: {
    typeoftrial: 'demographics'
},
}

var timeline = [demographics_survey1, demographics_survey2, demographics_survey3, demographics_survey4];

var thank_you = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: 'Thank you! You can press any key to end the experiment.',
    data: {
        typeoftrial: 'thank_you'
    },
}


function get_stimuli(CONDITION) {
    if (CONDITION == 0) {
        return [nonrhyme_sentences, nonrhyme_test_stimuli, association_cues_nonrhyme]
    } else if (CONDITION == 1) {
        return [rhyme_sentences, rhyme_test_stimuli, association_cues_rhyme]
    }
}

jsPsych.run([preload, initial_instructions, training_plus_association, priming_instructions, practice_procedure, priming_procedure, ending_instructions, demographics,participant_race, time_of_day_alert, dominant_hand, demographics_1, thank_you]);

        </script>
</HTML>
